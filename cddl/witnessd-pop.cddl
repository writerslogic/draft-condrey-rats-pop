; Proof of Process (PoP) Evidence and Attestation Result Schema
; draft-condrey-rats-pop-protocol-04 / draft-condrey-rats-pop-appraisal-03
;
; This schema defines the CBOR-encoded data structures for the
; Proof of Process framework. Evidence Packets are identified by
; CBOR tag 1347571280 ("POP ") and Attestation Results by
; CBOR tag 1463894560 ("WAR ").
;
; All map keys use integer encoding per IETF CBOR conventions.
; All floating-point fields MUST use 32-bit IEEE 754 binary32.
; pop-timestamp values MUST use floating-point encoding with
; at least millisecond precision.

; ============================================================
; CBOR Tag Wrappers
; ============================================================

pop-evidence = #6.1347571280(evidence-packet)
pop-war = #6.1463894560(attestation-result)

; ============================================================
; Evidence Packet (Protocol)
; ============================================================

evidence-packet = {
    1 => uint,                    ; version (MUST be 1)
    2 => tstr,                    ; profile-uri
    3 => uuid,                    ; packet-id
    4 => pop-timestamp,           ; created
    5 => document-ref,            ; document
    6 => [3* checkpoint],         ; checkpoints (min 3)
    ? 7 => attestation-tier,      ; T1-T4
    ? 8 => [* tstr],              ; limitations
    ? 9 => profile-declaration,   ; profile
    ? 10 => [+ presence-challenge], ; QR/OOB proofs
    ? 11 => channel-binding,      ; TLS EKM binding
    ; keys 14-17 reserved for future use
    ? 13 => content-tier,         ; Evidence Content Tier
    ? 18 => physical-liveness,    ; physical-liveness markers
    * int => any,                 ; extension fields
}

checkpoint = {
    1 => uint,                    ; sequence (monotonic)
    2 => uuid,                    ; checkpoint-id
    3 => pop-timestamp,           ; timestamp (local)
    4 => hash-value,              ; content-hash
    5 => uint,                    ; char-count
    6 => edit-delta,              ; delta
    7 => hash-value,              ; prev-hash
    8 => hash-value,              ; checkpoint-hash
    9 => process-proof,           ; SWF proof
    ? 10 => jitter-binding,       ; behavioral-entropy (ENHANCED+)
    ? 11 => physical-state,       ; CDCE Weave (ENHANCED+)
    ? 12 => bstr .size 32,        ; entangled-mac (ENHANCED+)
    * int => any,                 ; extension fields
}

document-ref = {
    1 => hash-value,              ; content-hash
    ? 2 => tstr,                  ; filename
    3 => uint,                    ; byte-length
    4 => uint,                    ; char-count
    ? 5 => hash-salt-mode,        ; salting mode
    ? 6 => bstr .size 32,         ; salt-commitment
}

; ============================================================
; Sequential Work Function (SWF)
; ============================================================

process-proof = {
    1 => proof-algorithm,         ; algorithm id
    2 => proof-params,            ; SWF params
    3 => bstr .size 32,           ; input (seed)
    4 => bstr .size 32,           ; merkle-root
    5 => [+ merkle-proof],        ; sampled proofs
    6 => float32,                 ; claimed-duration (seconds)
}

proof-params = {
    1 => uint,                    ; time-cost (t)
    2 => uint,                    ; memory-cost (m, KiB)
    3 => uint,                    ; parallelism (p)
    4 => uint,                    ; iterations
}

merkle-proof = {
    1 => uint,                    ; leaf-index
    2 => [+ bstr .size 32],       ; sibling-path
    3 => bstr .size 32,           ; leaf-value
}

; ============================================================
; Behavioral Entropy and Physical State
; ============================================================

jitter-binding = {
    1 => [+ float32],             ; intervals (ms)
    2 => float32,                 ; entropy-estimate (bits)
    3 => bstr .size 32,           ; jitter-seal (HMAC)
}

edit-delta = {
    1 => uint,                    ; chars-added
    2 => uint,                    ; chars-deleted
    3 => uint,                    ; op-count
    ? 4 => [* edit-position],     ; positions
}

edit-position = [
    uint,                         ; offset
    int,                          ; change (+/-), MUST be non-zero
]

physical-state = {
    1 => [+ float32],             ; thermal (relative)
    2 => int,                     ; entropy-delta (signed)
    ? 3 => bstr .size 32,         ; kernel-commitment
}

physical-liveness = {
    1 => [+ thermal-sample],      ; thermal trajectory
    2 => bstr .size 32,           ; entropy-anchor
}

thermal-sample = [
    pop-timestamp,                ; sample time
    float32,                      ; temperature delta
]

; ============================================================
; Presence Challenges and Profiles
; ============================================================

presence-challenge = {
    1 => bstr .size (16..256),    ; challenge-nonce (128+ bits)
    2 => bstr,                    ; device-signature (MUST be COSE_Sign1)
    3 => pop-timestamp,           ; response-time
}

profile-declaration = {
    1 => tstr,                    ; profile-id
    2 => [+ uint],                ; feature-flags
}

binding-type = &(
    tls-exporter: 1,
)

channel-binding = {
    1 => binding-type,            ; binding-type
    2 => bstr .size 32,           ; binding-value (EKM output)
}

; NOTE: Cross-session linking (continuation tokens) is deferred
; to a future revision. See draft-condrey-rats-pop-protocol.

; ============================================================
; Attestation Result / WAR (Appraisal)
; CBOR tag 1463894560
; ============================================================

attestation-result = {
    1 => uint,                    ; version (MUST be 1)
    2 => hash-value,              ; evidence-ref
    3 => verdict,                 ; appraisal verdict
    4 => attestation-tier,        ; assessed assurance level
    5 => uint,                    ; chain-length
    6 => uint,                    ; chain-duration (seconds)
    ? 7 => entropy-report,        ; entropy assessment (omit for CORE)
    ? 8 => forgery-cost-estimate, ; quantified forgery cost
    ? 9 => [+ absence-claim],     ; absence claims (1+ when present)
    ? 10 => [* tstr],             ; warnings
    11 => bstr,                   ; verifier-signature (COSE_Sign1)
    12 => pop-timestamp,          ; created (appraisal timestamp)
    * int => any,                 ; extension fields
}

verdict = &(
    authentic: 1,                 ; consistent with human authorship
    inconclusive: 2,              ; insufficient evidence
    suspicious: 3,                ; anomalies detected
    invalid: 4,                   ; chain broken or forged
)

entropy-report = {
    1 => float32,                 ; timing-entropy (bits/sample)
    2 => float32,                 ; revision-entropy (bits)
    3 => float32,                 ; pause-entropy (bits)
    4 => bool,                    ; meets-threshold
}

; ============================================================
; Forgery Cost Bound (Appraisal)
; ============================================================

forgery-cost-estimate = {
    1 => float32,                 ; c-swf
    2 => float32,                 ; c-entropy
    3 => float32,                 ; c-hardware
    4 => float32,                 ; c-total
    5 => cost-unit,               ; currency
}

cost-unit = &(
    usd: 1,
    cpu-hours: 2,
)

; ============================================================
; Absence Claims (Appraisal)
; ============================================================

absence-claim = {
    1 => absence-type,            ; proof category
    2 => time-window,             ; claimed window
    3 => tstr,                    ; claim-id
    ? 4 => any,                   ; threshold/parameter
    5 => bool,                    ; assertion
}

absence-type = &(
    computationally-bound: 1,     ; verifiable from Evidence alone
    monitoring-dependent: 2,      ; requires trust in AE monitoring
    environmental: 3,             ; environmental assertions
)

time-window = {
    1 => pop-timestamp,           ; start
    2 => pop-timestamp,           ; end
}

; ============================================================
; Enumerations
; ============================================================

attestation-tier = &(
    software-only: 1,             ; T1: AAL1
    attested-software: 2,         ; T2: AAL2
    hardware-bound: 3,            ; T3: AAL3
    hardware-hardened: 4,         ; T4: LoA4
)

content-tier = &(
    core: 1,
    enhanced: 2,
    maximum: 3,
)

proof-algorithm = &(
    ; 1 is reserved for future use
    pobst-argon2id: 20,
)

hash-salt-mode = &(
    unsalted: 0,
    author-salted: 1,
)

hash-algorithm = &(
    sha256: 1,
    sha384: 2,
    sha512: 3,
)

; ============================================================
; Base Types
; ============================================================

uuid = bstr .size 16
pop-timestamp = #6.1(float32)      ; CBOR tag 1 (epoch-based, float32)
hash-value = {
    1 => hash-algorithm,
    2 => bstr,
}
